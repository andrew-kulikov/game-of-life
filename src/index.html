<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link
      href="https://fonts.googleapis.com/css?family=Indie+Flower"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/style.css" />
    <title>Game of life</title>
  </head>
  <body>
    <header>
      <h1 class="main-header">Game of life</h1>
    </header>
    <main>
      <!-- <canvas id="myCanvas" width="512" height="512"></canvas> -->
      <div id="game"></div>
      <div class="controls">
        <div class="input-container">
          <label>Size</label>
          <input type="number" name="size" />
        </div>
        <div class="input-container">
          <label name="speed">Speed</label>
          <input type="number" name="speed" />
        </div>
      </div>
    </main>
    <!-- <script src="js/game.js"></script> -->
    <script>
      if (CSS.registerProperty)
        CSS.registerProperty({
          name: "--cells",
          inherits: false
        });
      const getCoordinatesMatrix = positions => {
        const cells = [];
        const cellsCount = 64;
        for (let i = 0; i < cellsCount; i++) {
          cells[i] = [];
          for (let j = 0; j < cellsCount; j++) {
            cells[i][j] = 0;
          }
        }

        positions.forEach(point => (cells[point[0]][point[1]] = 1));
        return cells;
      };
      document.addEventListener("DOMContentLoaded", e => {
        let game = document.getElementById("game");
        CSS.paintWorklet.addModule("js/board.js");

        const init = () => {
          let cells = [];
          const cellsCount = 64;
          for (let i = 0; i < cellsCount; i++) {
            cells[i] = [];
            for (let j = 0; j < cellsCount; j++) {
              cells[i][j] = 0;
            }
          }

          const coordinates = [
            [1, 5],
            [1, 6],
            [2, 5],
            [2, 6],
            [11, 5],
            [11, 6],
            [11, 7],
            [12, 4],
            [12, 8],
            [13, 3],
            [13, 9],
            [14, 3],
            [14, 9],
            [15, 6],
            [16, 4],
            [16, 8],
            [17, 5],
            [17, 6],
            [17, 7],
            [18, 6],
            [21, 3],
            [21, 4],
            [21, 5],
            [22, 3],
            [22, 4],
            [22, 5],
            [23, 2],
            [23, 6],
            [25, 1],
            [25, 2],
            [25, 6],
            [25, 7],
            [35, 3],
            [35, 4],
            [36, 3],
            [36, 4],

            [60, 47],
            [61, 47],
            [62, 47],
            [60, 48],
            [61, 48],
            [62, 48],
            [60, 49],
            [61, 49],
            [62, 49],
            [60, 51],
            [61, 51],
            [62, 51]
          ];
          coordinates.forEach(point => (cells[point[0]][point[1]] = 1));

          return coordinates;
        };

        let cellsPositions = init();
        let cells = getCoordinatesMatrix(cellsPositions);

        game.style.cssText = "--cells: " + cellsPositions.join(" ");

        const update = () => {
          function _countNeighbours(x, y) {
            let amount = 0;

            const _isAlive = (x, y) => cells[x] && cells[x][y];
            const offsets = [-1, 0, 1];

            offsets.forEach(offsetX =>
              offsets.forEach(
                offsetY => (amount += _isAlive(x + offsetX, y + offsetY))
              )
            );
            amount -= _isAlive(x, y);

            return amount;
          }
          let result = [];
          cellsPositions = [];
          cells.forEach((row, x) => {
            result[x] = [];
            row.forEach((cell, y) => {
              let alive = 0,
                count = _countNeighbours(x, y);

              if (cell > 0) alive = count === 2 || count === 3;
              else alive = count === 3;

              result[x][y] = alive ? 1 : 0;
              if (result[x][y]) cellsPositions.push([x, y]);
            });
          });

          cells = result;
          result = [];

          game.style.cssText = "--cells: " + cellsPositions.join(" ");
          setTimeout(() => window.requestAnimationFrame(update), 100);
        };

        window.addEventListener("keydown", e => {
          if (e.which == 96) {
            update();
          }
        });
      });
    </script>
  </body>
</html>
